--USE [Corporerm]
--GO

/****** Object:  UserDefinedFunction [dbo].[_Fluig_HISTORICOMOVIMENTO]    Script Date: 01/02/2022 16:21:16 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



CREATE FUNCTION [dbo].[_Fluig_HISTORICOMOVIMENTO] ( @IDMOV INT )
RETURNS @TAB TABLE (	IDMOV 		INT,
			CODTMV	VARCHAR(10),
			NOMETMV	VARCHAR(100),
			IDFLUIG	INT,
			ORDEM		INT IDENTITY 		)
AS
BEGIN
	INSERT INTO @TAB ( IDMOV, CODTMV, NOMETMV, IDFLUIG)
	
	SELECT DISTINCT TMOV.IDMOV,TMOV.CODTMV, TTMV.NOME AS NOMETMV, 
	CASE	WHEN TITMMOVWFLUIG.IDFLUIG IS NULL THEN TMOVCOMPL.IDFLUIG 
			ELSE TITMMOVWFLUIG.IDFLUIG END
			AS IDFLUIG
	FROM ( SELECT distinct IDMOV FROM [dbo].[RASTREIAMOVIMENTOS_CNC] (@IDMOV) )T1 
	JOIN TMOV ON (T1.IDMOV=TMOV.IDMOV)
	JOIN TTMV	ON (TMOV.CODTMV=TTMV.CODTMV)
	/*LEFT JOIN TITMMOVWFLUIG ON (TMOV.IDMOV=TITMMOVWFLUIG.IDMOV)*/
	JOIN TITMMOVWFLUIG ON (TMOV.IDMOV=TITMMOVWFLUIG.IDMOV)
	JOIN TMOVCOMPL ON (TMOV.IDMOV=TMOVCOMPL.IDMOV)
	WHERE TMOV.CODTMV	=	'1.1.65'	

	RETURN;
END


GO


